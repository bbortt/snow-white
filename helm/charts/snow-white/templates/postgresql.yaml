{{- if .Values.postgresql.enabled }}
{{- $secretName := "snow-white-postgresql-credentials" }}
{{- $reportCoordPassword := include "common.secrets.lookup" (dict "secret" $secretName "key" "report-coord-password" "defaultValue" "" "context" $) | trimAll "\"" | b64dec }}
{{- if (empty $reportCoordPassword) }}
{{- $reportCoordPassword = randAlphaNum 10 }}
{{- end }}
{{- $reportCoordFlywayPassword := include "common.secrets.lookup" (dict "secret" $secretName "key" "report-coord-flyway-password" "defaultValue" "" "context" $) | trimAll "\"" | b64dec }}
{{- if (empty $reportCoordFlywayPassword) }}
{{- $reportCoordFlywayPassword = randAlphaNum 10 }}
{{- end }}
{{- $qualityGatePassword := include "common.secrets.lookup" (dict "secret" $secretName "key" "quality-gate-password" "defaultValue" "" "context" $) | trimAll "\"" | b64dec }}
{{- if (empty $qualityGatePassword) }}
{{- $qualityGatePassword = randAlphaNum 10 }}
{{- end }}
{{- $qualityGateFlywayPassword := include "common.secrets.lookup" (dict "secret" $secretName "key" "quality-gate-flyway-password" "defaultValue" "" "context" $) | trimAll "\"" | b64dec }}
{{- if (empty $qualityGateFlywayPassword) }}
{{- $qualityGateFlywayPassword = randAlphaNum 10 }}
{{- end }}
{{- $labels := include "snow-white.labels" (dict "name" "postgresql" "context" .) | nindent 0 -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  labels:
    {{- $labels | nindent 4 }}
type: Opaque
data:
  {{- if $reportCoordPassword }}
  report-coord-password: {{ $reportCoordPassword | b64enc | quote }}
  {{- end }}
  {{- if $reportCoordFlywayPassword }}
  report-coord-flyway-password: {{ $reportCoordFlywayPassword | b64enc | quote }}
  {{- end }}
  {{- if $qualityGatePassword }}
  quality-gate-password: {{ $qualityGatePassword | b64enc | quote }}
  {{- end }}
  {{- if $qualityGateFlywayPassword }}
  quality-gate-flyway-password: {{ $qualityGateFlywayPassword | b64enc | quote }}
  {{- end }}
{{- end }}
---
{{- $labels := include "snow-white.labels" (dict "name" "postgresql" "context" .) | nindent 0 -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: 'snow-white-postgresql-init-scripts'
  labels:
    {{- $labels | nindent 4 }}
data:
  report-coordinator.sh: |
    # Backup and enable trust auth for postgres temporarily
    cp /opt/bitnami/postgresql/conf/pg_hba.conf /tmp/pg_hba.conf.backup
    sed -i '1i local   all             postgres                                trust' /opt/bitnami/postgresql/conf/pg_hba.conf
    kill -HUP $(cat /opt/bitnami/postgresql/tmp/postgresql.pid) 2>/dev/null || true
    sleep 1

    # Create database and user
    PGPASSWORD="$POSTGRESQL_PASSWORD" psql -v ON_ERROR_STOP=1 --username "$POSTGRESQL_USERNAME" --dbname "$POSTGRESQL_DATABASE" <<-EOSQL
      CREATE USER report_coord_flyway WITH PASSWORD '$REPORT_COORDINATOR_FLYWAY_PASSWORD';
      CREATE USER report_coord_app WITH PASSWORD '$REPORT_COORDINATOR_DATASOURCE_PASSWORD';

      CREATE DATABASE "report-coordinator-api" OWNER report_coord_flyway;

      \c "report-coordinator-api"

      GRANT CONNECT ON DATABASE "report-coordinator-api" TO report_coord_app;
      GRANT USAGE ON SCHEMA public TO report_coord_app;
      GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO report_coord_app;
      GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO report_coord_app;

      ALTER DEFAULT PRIVILEGES FOR USER report_coord_flyway IN SCHEMA public GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO report_coord_app;
      ALTER DEFAULT PRIVILEGES FOR USER report_coord_flyway IN SCHEMA public GRANT USAGE, SELECT ON SEQUENCES TO report_coord_app;
    EOSQL

    # Restore original auth config
    cp /tmp/pg_hba.conf.backup /opt/bitnami/postgresql/conf/pg_hba.conf
    kill -HUP $(cat /opt/bitnami/postgresql/tmp/postgresql.pid) 2>/dev/null || true

    echo "SUCCESS: Created 'report-coordinator-api' database and [ 'report_coord_app', 'report_coord_flyway' ] users"
  quality-gate.sh: |
    # Backup and enable trust auth for postgres temporarily
    cp /opt/bitnami/postgresql/conf/pg_hba.conf /tmp/pg_hba.conf.backup
    sed -i '1i local   all             postgres                                trust' /opt/bitnami/postgresql/conf/pg_hba.conf
    kill -HUP $(cat /opt/bitnami/postgresql/tmp/postgresql.pid) 2>/dev/null || true
    sleep 1

    # Create database and user
    PGPASSWORD="$POSTGRESQL_PASSWORD" psql -v ON_ERROR_STOP=1 --username "$POSTGRESQL_USERNAME" --dbname "$POSTGRESQL_DATABASE" <<-EOSQL
      CREATE USER quality_gate_flyway WITH PASSWORD '$QUALITY_GATE_FLYWAY_PASSWORD';
      CREATE USER quality_gate_app WITH PASSWORD '$QUALITY_GATE_DATASOURCE_PASSWORD';

      CREATE DATABASE "quality-gate-api" OWNER quality_gate_flyway;

      \c "quality-gate-api"

      GRANT CONNECT ON DATABASE "quality-gate-api" TO quality_gate_app;
      GRANT USAGE ON SCHEMA public TO quality_gate_app;
      GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO quality_gate_app;
      GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO quality_gate_app;

      ALTER DEFAULT PRIVILEGES FOR USER quality_gate_flyway IN SCHEMA public GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO quality_gate_app;
      ALTER DEFAULT PRIVILEGES FOR USER quality_gate_flyway IN SCHEMA public GRANT USAGE, SELECT ON SEQUENCES TO quality_gate_app;
    EOSQL

    # Restore original auth config
    cp /tmp/pg_hba.conf.backup /opt/bitnami/postgresql/conf/pg_hba.conf
    kill -HUP $(cat /opt/bitnami/postgresql/tmp/postgresql.pid) 2>/dev/null || true

    echo "SUCCESS: Created 'quality-gate-api' database and [ 'quality_gate_app', 'quality_gate_flyway' ] users"
